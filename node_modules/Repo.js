var fs = require('fs');
var exec = require('child_process').exec;
var execSync = require('child_process').execSync;

var Repo = new function(){

	this.reg = /^[a-zA-Z0-9\.\-\_]+$/;

	this.getLocalRepos = function(){
		var resp=[];
		var dir = fs.readdirSync(this.repoPath);
		for(i=0;i!=dir.length;i++){
			var stat = fs.statSync(this.repoPath+dir[i]);
			stat && stat.isDirectory() ? resp.push(dir[i]) : false;
		}
		return resp;
	}

	this.clone = function(repoName){
		try{
			repoName.match(this.reg) ?
				execSync('git clone '+this.remoteUser+'@'+this.remoteAddr+':'+repoName+' '+this.repoPath+repoName)
			: console.log('repoName is bad.');
		}
		catch(e){console.log('repoName not found.');}
	}

	this.pull = function(repoName){
		if(repoName.match(this.reg)){
			var saveDir=process.cwd();
			process.chdir(this.repoPath+repoName);
			var repoDir=process.cwd();
			process.chdir(saveDir);
			exec('git commit -a -m "fix changes"',{cwd:repoDir},function(error,stdout,stderr){
				exec('git pull --no-edit',{cwd:repoDir},function(error,stdout,stderr){
					stdout.match(/CONFLICT/) && exec('git push origin master:fixme && git reset --hard',{cwd:repoDir},function(){})
				});
			});
		}
		else console.log('repoName is bad.');
	}
}

module.exports=Repo;
